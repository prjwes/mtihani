<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Report Card Generator Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    input, button { display: block; margin: 12px 0; padding: 8px; }
    #downloadLink { margin-top: 20px; font-size: 18px; color: green; }
  </style>
</head>
<body>
  <h2>Test: Excel â†’ Multi-sheet Report Cards</h2>
  <input type="file" id="exam1" accept=".xlsx,.xls" />
  <input type="file" id="exam2" accept=".xlsx,.xls" />
  <button onclick="build()">Build</button>
  <a id="downloadLink"></a>
  <script src="xlsx.full.min.js"></script>
  <script>
    async function build() {
      const f1 = document.getElementById('exam1').files[0];
      const f2 = document.getElementById('exam2').files[0] || null;
      if (!f1) return alert('Need Exam 1');

      const d1 = await loadSheet(f1);
      const d2 = f2 ? await loadSheet(f2) : null;

      console.log('Sheet1 data:', d1);
      if (d2) console.log('Sheet2 data:', d2);

      const wb = XLSX.utils.book_new();
      const headers = d1[0];
      const students = d1.slice(1);

      students.forEach((row, i) => {
        const name = row[2] || 'Student' + (i+1);
        const adm = row[1] || '';
        const marks1 = row.slice(3);
        const marks2 = d2 ? (d2[i+1] || []).slice(3) : Array(marks1.length).fill('');

        const rub1 = marks1.map(m => rubric(m));
        const rub2 = marks2.map(m => rubric(m));

        const sheet = [
          ['St Michael Ebushibo School'],
          ['Name', name, 'Adm', adm],
          ['Subject','Exam1','Rub1','Exam2','Rub2','Comment']
        ];

        headers.slice(3).forEach((subj, j) =>
          sheet.push([
            subj, marks1[j], rub1[j][0], marks2[j], rub2[j][0], rub1[j][1]
          ])
        );

        const ws = XLSX.utils.aoa_to_sheet(sheet);
        XLSX.utils.book_append_sheet(wb, ws, name.substring(0,15));
      });

      const blob = XLSX.write(wb, {bookType:'xlsx', type:'blob'});
      const url = URL.createObjectURL(blob);
      const a = document.getElementById('downloadLink');
      a.href = url;
      a.download = 'cards.xlsx';
      a.textContent = 'Download cards.xlsx';
    }

    function loadSheet(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = e => {
          const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
          const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
          res(data);
        };
        r.onerror = rej;
        r.readAsArrayBuffer(file);
      });
    }

    function rubric(m) {
      m = parseFloat(m);
      if (isNaN(m)) return ['', ''];
      if (m <=10) return [0.5,'BE2'];
      if (m <=20) return [1,'BE1'];
      if (m <=30) return [1.5,'AE2'];
      if (m <=40) return [2,'AE1'];
      if (m <=57) return [2.5,'ME2'];
      if (m <=74) return [3,'ME1'];
      if (m <=89) return [3.5,'EE2'];
      return [4,'EE1'];
    }
  </script>
</body>
</html>
 
